{% extends "base.html" %}

{% block title %}Add Class - Fingerprint Attendance{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Page Header -->
    <div class="flex items-center space-x-4">
        <a href="{{ url_for('frontend.classes_list') }}" 
           class="text-gray-600 hover:text-gray-900">
            <i class="fas fa-arrow-left text-xl"></i>
        </a>
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-book-medical text-indigo-600"></i> Add New Class
        </h1>
    </div>
    
    <!-- Form -->
    <div class="bg-white shadow rounded-lg p-6">
        <form method="POST" class="space-y-6">
            <!-- Name -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                    Class Name <span class="text-red-500">*</span>
                </label>
                <input type="text" id="name" name="name" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="e.g., Computer Science 101">
            </div>
            
            <!-- Code -->
            <div>
                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">
                    Class Code
                </label>
                <input type="text" id="code" name="code" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="e.g., CS101">
                <p class="mt-1 text-sm text-gray-500">
                    Unique identifier for the class
                </p>
            </div>
            
            <!-- Teacher Name -->
            <div>
                <label for="teacher_name" class="block text-sm font-medium text-gray-700 mb-1">
                    Teacher Name
                </label>
                <input type="text" id="teacher_name" name="teacher_name" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="e.g., Dr. John Smith">
            </div>
            
            <!-- Schedule -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Class Schedule
                </label>
                <div class="space-y-3 bg-gray-50 p-4 rounded-md">
                    {% set days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
                    {% set day_labels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                    
                    {% for i in range(days|length) %}
                    {% set day = days[i] %}
                    {% set label = day_labels[i] %}
                    <div class="flex items-center space-x-4 bg-white p-3 rounded border border-gray-200">
                        <div class="flex items-center w-32">
                            <input type="checkbox" 
                                   id="schedule_{{ day }}_enabled" 
                                   name="schedule_{{ day }}_enabled"
                                   onchange="toggleScheduleDay('{{ day }}')"
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="schedule_{{ day }}_enabled" class="ml-2 text-sm font-medium text-gray-700">
                                {{ label }}
                            </label>
                        </div>
                        <div class="flex items-center space-x-2 flex-1">
                            <input type="time" 
                                   id="schedule_{{ day }}_start" 
                                   name="schedule_{{ day }}_start"
                                   disabled
                                   class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 schedule-time-{{ day }}">
                            <span class="text-gray-500">to</span>
                            <input type="time" 
                                   id="schedule_{{ day }}_end" 
                                   name="schedule_{{ day }}_end"
                                   disabled
                                   class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 schedule-time-{{ day }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <p class="mt-2 text-xs text-gray-500">
                    <i class="fas fa-info-circle"></i> Select days and set time ranges for each class session. Only one session per day is allowed.
                </p>
            </div>
            
            <script>
                function toggleScheduleDay(day) {
                    const checkbox = document.getElementById(`schedule_${day}_enabled`);
                    const timeInputs = document.querySelectorAll(`.schedule-time-${day}`);
                    
                    timeInputs.forEach(input => {
                        input.disabled = !checkbox.checked;
                        if (!checkbox.checked) {
                            input.value = '';
                        }
                    });
                    calculateTotalClassesAdd();
                }
                
                function calculateTotalClassesAdd() {
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    
                    if (!startDate || !endDate) {
                        document.getElementById('total-classes-display-add').style.display = 'none';
                        return;
                    }
                    
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    if (end < start) {
                        document.getElementById('total-classes-display-add').style.display = 'none';
                        return;
                    }
                    
                    // Get enabled days
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    const enabledDays = [];
                    days.forEach((day, index) => {
                        const checkbox = document.getElementById(`schedule_${day}_enabled`);
                        if (checkbox && checkbox.checked) {
                            enabledDays.push(index === 6 ? 0 : index + 1); // Convert to JS day format (0=Sunday)
                        }
                    });
                    
                    if (enabledDays.length === 0) {
                        document.getElementById('total-classes-display-add').style.display = 'none';
                        return;
                    }
                    
                    // Count classes between start and end date
                    let totalClasses = 0;
                    const currentDate = new Date(start);
                    
                    while (currentDate <= end) {
                        const dayOfWeek = currentDate.getDay();
                        if (enabledDays.includes(dayOfWeek)) {
                            totalClasses++;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // Update display
                    document.getElementById('total-classes-count-add').textContent = totalClasses;
                    document.getElementById('total_classes').value = totalClasses;
                    document.getElementById('total-classes-display-add').style.display = 'block';
                }
            </script>
            
            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                    Description
                </label>
                <textarea id="description" name="description" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          placeholder="Brief description of the class"></textarea>
            </div>
            
            <!-- Date Range -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">
                        Start Date
                    </label>
                    <input type="date" id="start_date" name="start_date"
                           onchange="calculateTotalClassesAdd()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="mt-1 text-xs text-gray-500">
                        Course start date
                    </p>
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">
                        End Date
                    </label>
                    <input type="date" id="end_date" name="end_date"
                           onchange="calculateTotalClassesAdd()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="mt-1 text-xs text-gray-500">
                        Course end date
                    </p>
                </div>
            </div>
            
            <!-- Total Classes Display -->
            <div id="total-classes-display-add" class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-calculator text-green-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm font-semibold text-gray-900">Total Available Classes</p>
                            <p class="text-xs text-gray-600">Based on date range and schedule</p>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-green-600" id="total-classes-count-add">0</p>
                </div>
            </div>
            <input type="hidden" id="total_classes" name="total_classes" value="0">
            
            <!-- Buttons -->
            <div class="flex items-center justify-end space-x-4 pt-4">
                <a href="{{ url_for('frontend.classes_list') }}" 
                   class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    <i class="fas fa-save mr-2"></i> Save Class
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
