{% extends "base.html" %}

{% block title %}Reports - Fingerprint Attendance{% endblock %}

{% block page_header %}
    <i class="fas fa-chart-bar mr-2"></i> Attendance Reports
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Page Header with Gradient -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl shadow-xl p-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Analytics Dashboard</h1>
                <p class="text-indigo-100">Comprehensive attendance insights and statistics</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-6 hidden md:block">
                <i class="fas fa-chart-line text-5xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Date Range Filter -->
    <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-blue-100">
            <h2 class="text-lg font-bold text-gray-800 flex items-center">
                <i class="fas fa-filter text-blue-600 mr-3"></i>
                Filter Reports
            </h2>
        </div>
        <div class="p-6">
            <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt text-green-500 mr-2"></i>Start Date
                    </label>
                    <input type="date" name="start_date" value="{{ start_date }}" required
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-calendar-check text-red-500 mr-2"></i>End Date
                    </label>
                    <input type="date" name="end_date" value="{{ end_date }}" required
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-book text-purple-500 mr-2"></i>Class Filter
                    </label>
                    <select name="class_id" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                        <option value="">All Classes</option>
                        {% for cls in classes %}
                            <option value="{{ cls.id }}" {% if class_filter == cls.id %}selected{% endif %}>
                                {{ cls.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg hover:from-indigo-700 hover:to-purple-700 shadow-lg transition transform hover:scale-105">
                        <i class="fas fa-sync-alt mr-2"></i> Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Records Card -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1 font-semibold">Total Records</p>
                    <p class="text-4xl font-bold">{{ total_records }}</p>
                    <p class="text-xs mt-2 opacity-75">Entry & Exit combined</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-4">
                    <i class="fas fa-clipboard-list text-3xl"></i>
                </div>
            </div>
            {% if total_records > 0 %}
            <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                <div class="flex items-center justify-between text-xs">
                    <span>Since {{ start_date }}</span>
                    <span class="bg-white bg-opacity-20 px-2 py-1 rounded">
                        <i class="fas fa-chart-line mr-1"></i>Active
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Present Card -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1 font-semibold">Present (On-Time)</p>
                    <p class="text-4xl font-bold">{{ present_count }}</p>
                    {% if total_records > 0 %}
                    <p class="text-xs mt-2 opacity-75">{{ "%.1f"|format((present_count / total_records * 100)) }}% of total</p>
                    {% else %}
                    <p class="text-xs mt-2 opacity-75">0.0% of total</p>
                    {% endif %}
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-4">
                    <i class="fas fa-check-circle text-3xl"></i>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                <div class="h-2 bg-white bg-opacity-20 rounded-full overflow-hidden">
                    {% if total_records > 0 %}
                    <div class="h-full bg-white rounded-full" style="width: {{ (present_count / total_records * 100)|round }}%"></div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Late Card -->
        <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1 font-semibold">Late Entry</p>
                    <p class="text-4xl font-bold">{{ late_count }}</p>
                    {% if total_records > 0 %}
                    <p class="text-xs mt-2 opacity-75">{{ "%.1f"|format((late_count / total_records * 100)) }}% of total</p>
                    {% else %}
                    <p class="text-xs mt-2 opacity-75">0.0% of total</p>
                    {% endif %}
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-4">
                    <i class="fas fa-clock text-3xl"></i>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                <div class="h-2 bg-white bg-opacity-20 rounded-full overflow-hidden">
                    {% if total_records > 0 %}
                    <div class="h-full bg-white rounded-full" style="width: {{ (late_count / total_records * 100)|round }}%"></div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Absent Card -->
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1 font-semibold">Absent</p>
                    <p class="text-4xl font-bold">{{ absent_count }}</p>
                    {% if total_records > 0 %}
                    <p class="text-xs mt-2 opacity-75">{{ "%.1f"|format((absent_count / total_records * 100)) }}% of total</p>
                    {% else %}
                    <p class="text-xs mt-2 opacity-75">0.0% of total</p>
                    {% endif %}
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-4">
                    <i class="fas fa-user-times text-3xl"></i>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                <div class="h-2 bg-white bg-opacity-20 rounded-full overflow-hidden">
                    {% if total_records > 0 %}
                    <div class="h-full bg-white rounded-full" style="width: {{ (absent_count / total_records * 100)|round }}%"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Visual Chart Section -->
    {% if total_records > 0 %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Attendance Distribution Chart -->
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-purple-100">
                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-chart-pie text-purple-600 mr-3"></i>
                    Attendance Distribution
                </h2>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <!-- Present Bar -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-circle text-green-500 mr-2 text-xs"></i>Present (On-Time)
                            </span>
                            <span class="text-sm font-bold text-green-600">{{ present_count }} ({{ "%.1f"|format((present_count / total_records * 100)) }}%)</span>
                        </div>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full transition-all duration-500" 
                                 style="width: {{ (present_count / total_records * 100)|round }}%"></div>
                        </div>
                    </div>
                    
                    <!-- Late Bar -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-circle text-yellow-500 mr-2 text-xs"></i>Late Entry
                            </span>
                            <span class="text-sm font-bold text-yellow-600">{{ late_count }} ({{ "%.1f"|format((late_count / total_records * 100)) }}%)</span>
                        </div>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-500" 
                                 style="width: {{ (late_count / total_records * 100)|round }}%"></div>
                        </div>
                    </div>
                    
                    <!-- Absent Bar -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-circle text-red-500 mr-2 text-xs"></i>Absent
                            </span>
                            <span class="text-sm font-bold text-red-600">{{ absent_count }} ({{ "%.1f"|format((absent_count / total_records * 100)) }}%)</span>
                        </div>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-red-400 to-red-600 rounded-full transition-all duration-500" 
                                 style="width: {{ (absent_count / total_records * 100)|round }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 px-6 py-4 border-b border-indigo-100">
                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-info-circle text-indigo-600 mr-3"></i>
                    Quick Insights
                </h2>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-green-700 font-semibold mb-1">Attendance Rate</p>
                            <p class="text-2xl font-bold text-green-600">{{ "%.1f"|format(((present_count + late_count) / total_records * 100)) }}%</p>
                        </div>
                        <i class="fas fa-percentage text-3xl text-green-500 opacity-50"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-blue-700 font-semibold mb-1">Punctuality Rate</p>
                            <p class="text-2xl font-bold text-blue-600">{{ "%.1f"|format((present_count / (present_count + late_count) * 100 if (present_count + late_count) > 0 else 0)) }}%</p>
                        </div>
                        <i class="fas fa-user-check text-3xl text-blue-500 opacity-50"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-purple-700 font-semibold mb-1">Absence Rate</p>
                            <p class="text-2xl font-bold text-purple-600">{{ "%.1f"|format((absent_count / total_records * 100)) }}%</p>
                        </div>
                        <i class="fas fa-chart-area text-3xl text-purple-500 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Top Students Section -->
    <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 px-6 py-4 border-b border-yellow-100">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-trophy text-yellow-500 mr-3"></i>
                    Top 10 Students by Attendance
                </h2>
                <span class="text-xs bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full font-bold">
                    <i class="fas fa-medal mr-1"></i>Leaderboard
                </span>
            </div>
        </div>
        <div class="p-6">
            {% if student_stats %}
                <div class="space-y-3">
                    {% for student in student_stats %}
                        <div class="flex items-center justify-between p-4 bg-gradient-to-r {% if loop.index == 1 %}from-yellow-50 to-yellow-100 border-2 border-yellow-300{% elif loop.index == 2 %}from-gray-50 to-gray-100 border-2 border-gray-300{% elif loop.index == 3 %}from-orange-50 to-orange-100 border-2 border-orange-300{% else %}from-gray-50 to-white border border-gray-200{% endif %} rounded-xl hover:shadow-md transition">
                            <div class="flex items-center space-x-4">
                                <!-- Rank Badge -->
                                <div class="flex-shrink-0">
                                    {% if loop.index == 1 %}
                                    <div class="h-12 w-12 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center shadow-lg">
                                        <i class="fas fa-crown text-white text-xl"></i>
                                    </div>
                                    {% elif loop.index == 2 %}
                                    <div class="h-12 w-12 rounded-full bg-gradient-to-br from-gray-300 to-gray-500 flex items-center justify-center shadow-lg">
                                        <span class="text-white font-bold text-lg">2</span>
                                    </div>
                                    {% elif loop.index == 3 %}
                                    <div class="h-12 w-12 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center shadow-lg">
                                        <span class="text-white font-bold text-lg">3</span>
                                    </div>
                                    {% else %}
                                    <div class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-100 to-indigo-200 flex items-center justify-center">
                                        <span class="text-indigo-600 font-bold text-lg">{{ loop.index }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Student Info -->
                                <div>
                                    <p class="text-base font-bold text-gray-900">{{ student.name }}</p>
                                    <p class="text-xs text-gray-500 flex items-center mt-1">
                                        <i class="fas fa-id-card mr-1"></i>
                                        Student ID: {{ student.id }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Attendance Count -->
                            <div class="text-right">
                                <div class="flex items-center space-x-2">
                                    <div class="text-right">
                                        <p class="text-2xl font-bold {% if loop.index <= 3 %}text-indigo-600{% else %}text-gray-700{% endif %}">
                                            {{ student.total_attendance }}
                                        </p>
                                        <p class="text-xs text-gray-500 font-semibold">records</p>
                                    </div>
                                    <i class="fas fa-chart-line text-2xl {% if loop.index <= 3 %}text-indigo-500{% else %}text-gray-400{% endif %}"></i>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- View All Link -->
                <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                    <a href="{{ url_for('frontend.classes_list') }}" 
                       class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-lg hover:from-indigo-600 hover:to-purple-700 transition transform hover:scale-105 shadow-md">
                        <i class="fas fa-book mr-2"></i>
                        View Class-Wise Reports
                    </a>
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="bg-gray-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-chart-line text-5xl text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">No Data Available</h3>
                    <p class="text-gray-500 mb-6">No attendance records found for the selected period</p>
                    <a href="?start_date={{ (start_date|string)[:7] }}-01&end_date={{ start_date }}" 
                       class="inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Try Different Date Range
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Additional Info Section -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border-l-4 border-indigo-500">
        <div class="flex items-start space-x-4">
            <div class="bg-indigo-100 rounded-full p-3">
                <i class="fas fa-info-circle text-2xl text-indigo-600"></i>
            </div>
            <div>
                <h3 class="font-bold text-gray-800 mb-2">About This Report</h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <strong>Present:</strong>&nbsp;Students who arrived on time (within 5 minutes of class start)
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-clock text-yellow-500 mr-2"></i>
                        <strong>Late:</strong>&nbsp;Students who arrived more than 5 minutes after class start
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-user-times text-red-500 mr-2"></i>
                        <strong>Absent:</strong>&nbsp;Students who didn't mark attendance
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-calculator text-blue-500 mr-2"></i>
                        <strong>Records:</strong>&nbsp;Each entry and exit is tracked separately for duration calculation
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
